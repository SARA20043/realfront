<div class="topbar">
  <div class="logo">
    <img src="assets/logo-eng.jpg" alt="ENG Logo" />
    <span class="site-name">Gestion des parcs des √©quipements</span>
  </div>

  <div class="menu-center">
    <a class="menu-button" href="#">Dashbord</a>
    <a class="menu-button" href="/equipement">√âquipement</a>
    <a class="menu-button" href="#">Utilisateur</a>
    <div class="dropdown">
      <button class="menu-button">Mouvement</button>
      <div class="dropdown-content">
        <a href="#">R√©forme</a>
        <a href="#">R√©affectation</a>
        <a href="#">Pr√™t</a>
      </div>
    </div>
    <div class="dropdown">
      <button class="menu-button">Table de Codification</button>
      <div class="dropdown-content">
        <a href="/marque">Marque</a>
        <a href="/organe">Organe</a>
        <a href="/unite">Unit√©</a>
        <a href="/categorie">Cat√©gorie</a>
        <a href="/typeeq">Type</a>
        <a href="/caracteristique">Caract√©ristique</a>
        <a href="/groupeidentique">Groupe Identique</a>
      </div>
    </div>
  </div>

  <div class="profile" (click)="profileOpen = !profileOpen">
    <img class="profile-img" src="assets/user.png" alt="Profil utilisateur" />
    <span class="profile-name">{{ username }}</span>
    <div class="profile-menu" *ngIf="profileOpen">
      <div class="menu-username">{{ username }}</div>
      <button class="logout-btn" (click)="logout()">D√©connexion</button>
    </div>
  </div>
</div>

<!-- Page content starts here -->
<div class="container">
  <div class="toolbar">
    <input class="form-control" type="text" [(ngModel)]="searchTerm" placeholder="üîç Rechercher..." (input)="search()" />
    <select class="form-control" [(ngModel)]="sortBy" (change)="search()">
      <option value="codeEqp">Code</option>
      <option value="design">D√©signation</option>
      <option value="etat">√âtat</option>
    </select>
    <button class="btn sort-btn" (click)="toggleSort(sortBy)">
      <span class="arrow">{{ ascending ? '‚ñ≤' : '‚ñº' }}</span>
    </button>
    <div class="spacer"></div>
    <button class="btn orange" (click)="openForm()">+ Ajouter √âquipement</button>
  </div>

  <h2 class="header">Liste des √âquipements
    <span class="tooltip badge">
      {{ equipements.length }}
      <span class="tooltip-text">Nombre total des √âquipements</span>
    </span>
  </h2>

  <table class="equipement-table">
    <thead>
      <tr>
        <th>Code</th>
        <th>D√©signation</th>
        <th>√âtat</th>
        <th>Groupe Identique</th>
        <th>Unit√©</th>
        <th>Caract√©ristiques</th>
        <th>Organes</th>
        <th style="text-align: left;">
          <span style="display: inline-block; transform: translateX(200px);">Actions</span>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let eq of equipements">
        <td>{{ eq.codeEqp }}</td>
        <td>{{ eq.design }}</td>
        <td>{{ eq.etat }}</td>
        <td>{{ eq.groupeIdentiqueDesignation || '-' }}</td>
        <td>{{ eq.uniteDesignation || '-' }}</td>
        <td>
          <ng-container *ngIf="eq.caracteristiques && eq.caracteristiques.length > 0; else noCarac">
            <div *ngFor="let c of eq.caracteristiques">
              {{ c.nomcarac || c.designation || c.libelle || c.nomCaracteristique || c.nom || c.name }}: {{ c.valeur || c.value }}
            </div>
          </ng-container>
          <ng-template #noCarac>Aucune</ng-template>
        </td>
        <td>
          <ng-container *ngIf="eq.organes && eq.organes.length > 0; else noOrgane">
            <div *ngFor="let o of eq.organes">
              {{ o.libelle_organe || o.nomOrgane || o.libelle || o.name }}
              <span *ngIf="o.numserie || o['nums√©rie']">
                (SN: {{ o.numserie || o['nums√©rie'] }})
              </span>
            </div>
          </ng-container>
          <ng-template #noOrgane>Aucun</ng-template>
        </td>
        <td>
          <button class="btn orange tooltip me-2" (click)="openForm(eq)">
            ‚úèÔ∏è
            <span class="tooltip-text">Modifier cet √©quipement</span>
          </button>
          <button class="btn grey tooltip tooltip-left" (click)="deleteEquipement(eq)">
            üóëÔ∏è
            <span class="tooltip-text">Supprimer cet √©quipement</span>
          </button>
          <button *ngIf="!eq.idunite" class="btn orange" (click)="openAffectModal(eq)">Affecter</button>
        </td>
      </tr>
      <tr *ngIf="equipements.length === 0">
        <td colspan="6" class="empty-row">Aucun √©quipement trouv√©.</td>
      </tr>
    </tbody>
  </table>

  <!-- MODALE SUPPRESSION -->
  <div class="modal" *ngIf="showDeleteConfirm">
    <div class="form">
      <h3>Confirmer la suppression</h3>
      <p>Voulez-vous vraiment supprimer cet √©quipement ?</p>
      <div class="actions">
        <button class="btn orange" (click)="confirmDelete()">Supprimer</button>
        <button class="btn grey" (click)="cancelDelete()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- MODAL for add/edit equipement -->
  <div class="modal" *ngIf="showForm">
    <div class="form">
      <h3>{{ selectedEquipement ? 'Modifier' : 'Ajouter' }} un √âquipement</h3>
      <input class="form-control" type="text" [(ngModel)]="design_input" placeholder="D√©signation" />
      <select class="form-control" [(ngModel)]="etat_input" required>
        <option value="">S√©lectionner un √©tat</option>
        <option value="En Service">En Service</option>
        <option value="En panne">En panne</option>
        <option value="En stock">En stock</option>
        <option value="R√©form√©">R√©form√©</option>
        <option value="Pr√™t">Pr√™t</option>
      </select>
      <select class="form-control" [(ngModel)]="idType_input" required (change)="onTypeOrMarqueChange()">
        <option value="">S√©lectionner un type</option>
        <option *ngFor="let type of types" [value]="type.idtypequip">{{ type.designation }}</option>
      </select>
      <select class="form-control" [(ngModel)]="idCat_input" required>
        <option value="">S√©lectionner une cat√©gorie</option>
        <option *ngFor="let cat of categories" [value]="cat.idcategorie">{{ cat.design }}</option>
      </select>
      <select class="form-control" [(ngModel)]="idMarq_input" required (change)="onTypeOrMarqueChange()">
        <option value="">S√©lectionner une marque</option>
        <option *ngFor="let marque of marques" [value]="marque.idmarque">{{ marque.nom_fabriquant }}</option>
      </select>
      <input class="form-control" type="date" [(ngModel)]="dateMiseService_input" placeholder="Date de mise en service" />
      <input class="form-control" type="number" [(ngModel)]="anneeFabrication_input" placeholder="Ann√©e de fabrication" min="1900" max="2100" />
      <input class="form-control" type="date" [(ngModel)]="dateAcquisition_input" placeholder="Date d'acquisition" />
      <input class="form-control" type="number" [(ngModel)]="valeurAcquisition_input" placeholder="Valeur d'acquisition" min="0" step="0.01" />
      <!-- Caract√©ristiques Section -->
      <div class="form-group">
        <label>Caract√©ristiques</label>
        <div class="caracteristiques-list">
          <div *ngFor="let carac of caracteristiques" class="carac-item">
            <input type="checkbox" [(ngModel)]="carac.checked" [name]="'carac-' + carac.id_caracteristique" />
            <label>{{ carac.libelle }}</label>
            <input *ngIf="carac.checked" type="text" class="value-input" [(ngModel)]="carac.valeur" [name]="'value-' + carac.id_caracteristique" placeholder="Valeur..." />
          </div>
        </div>
      </div>
      <!-- Organes Section -->
      <div class="form-group">
        <label>Organes</label>
        <div class="caracteristiques-list">
          <div *ngFor="let org of organes" class="carac-item">
            <input type="checkbox" [(ngModel)]="org.checked" [name]="'organe-' + org.id_organe" />
            <label>{{ org.libelle_organe }}</label>
            <input *ngIf="org.checked" type="text" class="value-input" [(ngModel)]="org.numserie" [name]="'numserie-' + org.id_organe" placeholder="Num√©ro de s√©rie..." />
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn orange" (click)="saveEquipement()">üíæ Enregistrer</button>
        <button class="btn grey" (click)="closeForm()">‚ùå Annuler</button>
      </div>
    </div>
  </div>

  <!-- Affectation Modal -->
  <div class="modal" *ngIf="showAffectModal">
    <div class="form">
      <h3>Affecter un √âquipement</h3>
      <div class="form-group">
        <label>Unit√©</label>
        <select class="form-control" [(ngModel)]="affectUnite">
          <option value="">S√©lectionner une unit√©</option>
          <option *ngFor="let unite of unites" [value]="unite.idunite">{{ unite.designation || unite.nom || unite.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Date d'affectation</label>
        <input class="form-control" type="date" [(ngModel)]="affectDate" />
      </div>
      <div class="actions">
        <button class="btn orange" (click)="submitAffectation()">Enregistrer</button>
        <button class="btn grey" (click)="closeAffectModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div> 